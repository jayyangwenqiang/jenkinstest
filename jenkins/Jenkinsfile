pipeline {
    agent any
    stages {
        stage('Build Image') {
            steps {
                sshPublisher(
                    publishers: [
                    sshPublisherDesc(
                        configName: 'myserver',
                        transfers: [
                        sshTransfer(
                            excludes: '',
                            execCommand: '''
                                set -ex && cd /home/app && rm -rf jenkinstest && \
                                git clone https://github.com/jayyangwenqiang/jenkinstest.git && \
                                cd jenkins/ &&  mvn package -Dmaven.test.skip=true && docker build -t jenkinstest:v1.0 .
                            ''',
                        )
                    ],
                    verbose: true
                    )
                ]
                )
            }
        }

        stage('deploy') {
            steps {
                sshPublisher(
                    publishers: [
                    sshPublisherDesc(
                        configName: 'myserver',
                        transfers: [
                        sshTransfer(
                            excludes: '',
                            execCommand: '''
                                set -ex && docker run -d --name jenkinstest2 -p 8802:8802 jenkinstest:v1.0
                            ''',
                        )
                    ],
                    verbose: true
                    )
                ]
                )
            }
        }
    }

    post {
        always {
            println "构建.."
        }

        success {
            echo '发布成功'
        }
        unstable {
            echo '不稳定'
        }
        failure {
            echo '发布失败！'
        }
        changed {
            echo '项目变更'
        }
    }
}